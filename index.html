<!DOCTYPE html>
<html lang="de" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <title>Bio-Pflanzenschutz – All in One (JSON Datenbank)</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />

  <style>
    /**************************************************************
     *         DUNKLES DESIGN + SCHRIFTFARBEN IM BROWSER
     **************************************************************/
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow-x: hidden; /* Kein horizontaler Scrollbalken */
      font-family: "Helvetica Neue", Arial, sans-serif;
      background-color: #000; /* echter dunkler Hintergrund */
      color: #fff;            /* helle Schrift */
      position: relative;
      z-index: 0;
    }

    /* Damit man den Sternenhimmel hinter dem Body sieht, 
       setzen wir Body auf transparent und html auf schwarz. */
    html {
      background-color: #000;
    }
    body {
      background: transparent;
    }

    /**************************************************************
     *                STERNENHIMMEL (CANVAS)
     **************************************************************/
    #starCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1; /* hinter dem Body */
      display: block;
      background: transparent;
    }

    /**************************************************************
     *                NAVBAR & LOGO
     **************************************************************/
    .navbar {
      background-color: #222 !important; /* dunkles Grau */
      border-bottom: 2px solid #82c91e;
    }
    .navbar .navbar-brand {
      display: flex;
      align-items: center;
      color: #fff !important;
      text-decoration: none;
    }
    .navbar .navbar-brand:hover {
      color: #82c91e !important;
    }
    .navbar .logo {
      width: 180px;
      height: auto;
    }
    .navbar .btn {
      color: #fff;
      border-color: #ccc;
    }
    .navbar .btn:hover {
      background-color: #444;
      color: #fff;
    }

    /**************************************************************
     *                ÜBERSCHRIFTEN IN GRÜN
     **************************************************************/
    h1, h2, h3, h4 {
      color: #2f9e44; 
    }

    /**************************************************************
     *                KARTEN (CARDS) IM DUNKLEN MODUS
     **************************************************************/
    .card {
      background-color: #2b2b2b;
      color: #fff;
      border: none;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
      margin-bottom: 1.5rem;
    }
    .card-header {
      background-color: #3a3a3a;
      border-bottom: 1px solid #444;
    }
    /* BG-Farben für bestimmte Bootstrap-Klassen anpassen */
    .card-header.bg-success {
      background-color: #198754 !important; 
      color: #fff !important;
    }
    .card-header.bg-info {
      background-color: #0dcaf0 !important;
      color: #fff !important;
    }

    /**************************************************************
     *                TABELLEN IM DUNKLEN MODUS
     **************************************************************/
    table {
      color: #fff;           /* weiße Schrift im Browser */
      background-color: #2b2b2b; /* Tabellen-Hintergrund */
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    thead tr {
      background-color: #3a3a3a; /* dunkler Kopf */
    }
    thead th {
      color: #fff;
      border-bottom: 1px solid #444;
    }
    tbody tr {
      border-bottom: 1px solid #444;
    }
    tbody tr:hover {
      background-color: #464646;
    }
    .table-responsive {
      overflow: visible !important;
    }

    /**************************************************************
     *                FOOTER (fixiert unten)
     **************************************************************/
    footer.footer {
      background-color: #222;
      color: #fff;
      padding: 10px 0;
      position: fixed;
      bottom: 0;
      width: 100%;
      text-align: center;
      font-size: 0.9rem;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
    }

    /**************************************************************
     *                DRUCK-STYLES (ALLES WEISS!)
     **************************************************************/
    @media print {
      /* Unsichtbar beim Drucken */
      .no-print,
      .btn,
      .navbar,
      footer,
      #startup,
      #starCanvas {
        display: none !important;
      }
      /* Komplett weißer Hintergrund, schwarze Schrift */
      html, body, .card, .table, .card-header {
        background-color: #fff !important;
        color: #000 !important;
      }
      .container {
        margin: 0 !important;
        padding: 0 !important;
        max-width: 100% !important;
        width: 100% !important;
      }
      /* Tabellen-Kopf hellgrau, Text schwarz */
      thead tr {
        background-color: #eee !important;
        color: #000 !important;
      }
      thead th, tbody tr, tbody td {
        border: 1px solid #000 !important;
      }
      tbody tr:hover {
        background-color: #fff !important;
      }
    }
  </style>
</head>
<body>

<!-- Sternenhimmel-Canvas -->
<canvas id="starCanvas"></canvas>

<!-- Startup-Bereich: Auswahl der JSON-Datenbank -->
<div id="startup" class="container my-5">
  <h2 class="text-center mb-4">JSON-Datenbank auswählen</h2>
  <p class="text-center">
    Bitte wählen Sie, ob Sie eine neue Datenbank erstellen oder eine bestehende Datei verbinden möchten.
  </p>
  <div class="text-center">
    <button id="createDbBtn" class="btn btn-primary me-2">Neue Datenbank erstellen</button>
    <button id="openDbBtn" class="btn btn-secondary">Bestehende Datenbank verbinden</button>
  </div>
  <p class="mt-3 text-muted text-center">
    (Der vorgeschlagene Speicherort ist der gleiche Ordner wie diese WebApp)
  </p>
</div>

<!-- Hauptbereich der WebApp (wird erst nach Auswahl der DB angezeigt) -->
<div id="mainApp" class="d-none">
  <!-- Navbar -->
  <nav class="navbar navbar-dark no-print mb-4">
    <div class="container">
      <a class="navbar-brand" href="#" onclick="showSection('calc')">
        <img 
          src="https://jungpflanzen.bio/wp-content/uploads/2024/01/Baerthele_Jungpflanzen_Markenzeichen.svg"
          alt="Firmalogo"
          class="logo"
        />
        <span class="ms-3 h4 mb-0 text-success">Bio-Pflanzenschutz – All in One</span>
      </a>
      <div>
        <button class="btn btn-sm btn-outline-light" onclick="showSection('calc')">Berechnung</button>
        <button class="btn btn-sm btn-outline-light" onclick="showSection('history')">Historie</button>
        <button class="btn btn-sm btn-outline-light" onclick="showSection('settings')">Einstellungen</button>
        <button class="btn btn-sm btn-outline-light" onclick="showSection('report')">Auswertung</button>
      </div>
    </div>
  </nav>
  
  <!-- SECTION: BERECHNUNG -->
  <div class="container mb-5" id="section-calc">
    <h2 class="text-center text-success mb-4">Mittelberechnung – Bio-Pflanzenschutz</h2>
    <div class="card mb-4">
      <div class="card-body">
        <form id="calculationForm" class="row g-3 no-print">
          <div class="col-md-3">
            <label for="ersteller" class="form-label">Erstellt von</label>
            <input type="text" class="form-control" id="ersteller" required />
          </div>
          <div class="col-md-3">
            <label for="standort" class="form-label">Standort / Abteil</label>
            <input type="text" class="form-control" id="standort" />
          </div>
          <div class="col-md-3">
            <label for="kultur" class="form-label">Kultur</label>
            <input type="text" class="form-control" id="kultur" placeholder="z. B. Kohl, Salat, ..." />
          </div>
          <div class="col-md-3">
            <label for="kistenanzahl" class="form-label">Anzahl Kisten</label>
            <input type="number" class="form-control" id="kistenanzahl" required />
          </div>
          <div class="col-12 text-center">
            <button type="submit" class="btn btn-success px-4">Berechnen</button>
          </div>
        </form>
      </div>
    </div>
  
    <!-- Ergebnis der Berechnung -->
    <div id="resultSection" class="card d-none">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">Benötigte Mittel</h5>
      </div>
      <div class="card-body">
        <p>
          <strong>Erstellt von:</strong> <span id="erstellerName"></span><br/>
          <strong>Standort / Abteil:</strong> <span id="standortName"></span><br/>
          <strong>Kultur:</strong> <span id="kulturName"></span><br/>
          <strong>Datum:</strong> <span id="datum"></span>
        </p>
        <div class="table-responsive">
          <table class="table table-striped align-middle" id="resultsTable">
            <thead>
              <tr>
                <th>Mittel</th>
                <th>Einheit</th>
                <th>Methode</th>
                <th>Wert</th>
                <th>Anzahl Kisten</th>
                <th>Ar</th>
                <th>m²</th>
                <th>Gesamt</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="mt-3 no-print">
          <button class="btn btn-outline-secondary" onclick="window.print()">Drucken / PDF</button>
          <button class="btn btn-primary ms-2" id="saveHistoryBtn">Aktuelle Berechnung speichern</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- SECTION: HISTORIE -->
  <div class="container mb-5 d-none" id="section-history">
    <h2 class="text-success text-center mb-4">Historie – Frühere Einträge</h2>
    <div class="table-responsive">
      <table class="table table-bordered align-middle" id="historyTable">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Erstellt von</th>
            <th>Standort</th>
            <th>Kultur</th>
            <th>Kisten</th>
            <th>Aktion</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="detailSection" class="card mt-4 d-none">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">Details</h5>
      </div>
      <div class="card-body" id="detailBody">
        <!-- Detailansicht wird per JS befüllt -->
      </div>
    </div>
  </div>
  
  <!-- SECTION: EINSTELLUNGEN -->
  <div class="container my-4 d-none" id="section-settings">
    <h2 class="text-success text-center mb-4">Mittel-Verwaltung</h2>
    <table class="table table-bordered" id="mittelTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Einheit</th>
          <th>Methode</th>
          <th>Wert</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <hr/>
    <h4>Neues Mittel hinzufügen</h4>
    <form id="addMittelForm" class="row g-3">
      <div class="col-md-3">
        <input type="text" class="form-control" placeholder="Name (z. B. Elot-Vis)" id="mittelName" required />
      </div>
      <div class="col-md-2">
        <input type="text" class="form-control" placeholder="Einheit (z. B. ml, %)" id="mittelUnit" required />
      </div>
      <div class="col-md-3">
        <select id="mittelMethod" class="form-select" required>
          <option value="perKiste">perKiste</option>
          <option value="percentWater">% vom Wasser</option>
        </select>
      </div>
      <div class="col-md-2">
        <input type="number" step="any" class="form-control" placeholder="Wert" id="mittelValue" required />
      </div>
      <div class="col-md-2">
        <button class="btn btn-success w-100" type="submit">Hinzufügen</button>
      </div>
    </form>
  </div>
  
  <!-- SECTION: AUSWERTUNG -->
  <div class="container mb-5 d-none" id="section-report">
    <h2 class="text-success text-center mb-4">Auswertung nach Datum</h2>
    <div class="card mb-3 no-print">
      <div class="card-body">
        <form id="filterForm" class="row g-3">
          <div class="col-md-4">
            <label for="startDate" class="form-label">Startdatum</label>
            <input type="date" class="form-control" id="startDate" required />
          </div>
          <div class="col-md-4">
            <label for="endDate" class="form-label">Enddatum</label>
            <input type="date" class="form-control" id="endDate" required />
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button type="submit" class="btn btn-success w-100">Anzeigen</button>
          </div>
        </form>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered" id="auswertungTable">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Erstellt von</th>
            <th>Standort</th>
            <th>Kultur</th>
            <th>Kisten</th>
            <th>Mittel &amp; Gesamtmengen</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Footer (nur im Browser sichtbar) -->
<footer class="footer no-print">
  <div class="container">
    <p class="mb-0">
      Entwickler:
      <a href="mailto:abbas.hoseiny@gmx.de" style="color: #fff; text-decoration: underline;">
        abbas.hoseiny@gmx.de
      </a>
    </p>
  </div>
</footer>

<!-- Bootstrap Bundle (JS) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- ==========================================================
     STERNENHIMMEL-ANIMATION (CANVAS)
     Achtung: Bei local file://... kann es zu Blockaden kommen
   ========================================================== -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    console.log("Starfield-Skript gestartet...");
    const starCanvas = document.getElementById("starCanvas");
    if (!starCanvas) {
      console.log("Kein starCanvas gefunden!");
      return;
    }
    const ctx = starCanvas.getContext("2d");

    function resizeCanvas() {
      starCanvas.width = window.innerWidth;
      starCanvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // Zufällige Sterne generieren
    let stars = [];
    const numStars = 150;
    for (let i = 0; i < numStars; i++) {
      stars.push({
        x: Math.random() * starCanvas.width,
        y: Math.random() * starCanvas.height,
        r: Math.random() * 2 + 0.5,      // Stern-Größe
        dx: (Math.random() - 0.5) * 0.3, // X-Geschwindigkeit
        dy: (Math.random() - 0.5) * 0.3  // Y-Geschwindigkeit
      });
    }

    // Animationsschleife
    function animateStars() {
      ctx.clearRect(0, 0, starCanvas.width, starCanvas.height);
      ctx.fillStyle = "#fff";
      for (let star of stars) {
        ctx.beginPath();
        ctx.arc(star.x, star.y, star.r, 0, 2 * Math.PI);
        ctx.fill();

        // Stern bewegt sich minimal
        star.x += star.dx;
        star.y += star.dy;

        // Rand-Wrapping
        if (star.x < 0) star.x = starCanvas.width;
        if (star.x > starCanvas.width) star.x = 0;
        if (star.y < 0) star.y = starCanvas.height;
        if (star.y > starCanvas.height) star.y = 0;
      }
      requestAnimationFrame(animateStars);
    }
    animateStars();
  });
</script>

<!-- ==========================================================
     HAUPT-JS: Datenbank, Historie, Einstellungen usw.
   ========================================================== -->
<script>
  /* ==========================================================
     Globale Variablen und Datenhaltung
  ========================================================= */
  let dbFileHandle = null;      // Handle zur JSON-Datei
  let database = {              // Datenstruktur: { mittel: [...], history: [...] }
    mittel: [],
    history: []
  };
  let mittelDaten = [];         // Array für die Mittel (aus database.mittel)
  let historyData = [];         // Array für die Historie (aus database.history)
  let currentCalculation = null;  // Aktuell berechnetes Ergebnis
  
  /* ==========================================================
     Funktionen zur Dateispeicherung (JSON DB)
  ========================================================= */
  // Speichert das "database"-Objekt in der Datei
  async function saveDatabase() {
    if (!dbFileHandle) {
      console.error("Kein Dateihandle vorhanden!");
      return;
    }
    try {
      database.mittel = mittelDaten;
      database.history = historyData;
      const writable = await dbFileHandle.createWritable();
      await writable.write(JSON.stringify(database, null, 2));
      await writable.close();
    } catch (err) {
      console.error("Fehler beim Speichern der Datenbank:", err);
    }
  }
  
  // Lädt die Daten aus der ausgewählten Datei
  async function loadDatabase() {
    if (!dbFileHandle) return;
    try {
      const file = await dbFileHandle.getFile();
      const text = await file.text();
      database = JSON.parse(text);
      mittelDaten = database.mittel || [];
      historyData = database.history || [];
    } catch (err) {
      console.error("Fehler beim Laden der Datenbank:", err);
    }
  }
  
  /* ==========================================================
     Startup-Funktionen: Datenbank auswählen
  ========================================================= */
  // Neue Datenbank erstellen: File Save Picker (Vorschlag: "database.json")
  async function createNewDatabase() {
    try {
      const opts = {
        suggestedName: 'database.json',
        types: [{
          description: 'JSON-Datei',
          accept: { 'application/json': ['.json'] }
        }]
      };
      dbFileHandle = await window.showSaveFilePicker(opts);
      // Initiale Daten
      database = {
        mittel: [
          { name: "Spruzit", unit: "ml", calcMethod: "perKiste", value: 0.2 }
        ],
        history: []
      };
      mittelDaten = database.mittel;
      historyData = database.history;
      await saveDatabase();
      document.getElementById('startup').classList.add('d-none');
      document.getElementById('mainApp').classList.remove('d-none');
      initializeApp();
    } catch (err) {
      console.error("Fehler beim Erstellen der neuen Datenbank:", err);
    }
  }
  
  // Bestehende Datenbank öffnen: File Open Picker
  async function openDatabase() {
    try {
      const [handle] = await window.showOpenFilePicker({
        types: [{
          description: 'JSON-Datei',
          accept: { 'application/json': ['.json'] }
        }]
      });
      dbFileHandle = handle;
      await loadDatabase();
      document.getElementById('startup').classList.add('d-none');
      document.getElementById('mainApp').classList.remove('d-none');
      initializeApp();
    } catch (err) {
      console.error("Fehler beim Öffnen der Datenbank:", err);
    }
  }
  
  /* ==========================================================
     UI-Navigation: Sections ein-/ausblenden
  ========================================================= */
  function showSection(name) {
    const sections = ["calc", "history", "settings", "report"];
    sections.forEach(s => {
      document.getElementById("section-" + s).classList.add("d-none");
    });
    document.getElementById("section-" + name).classList.remove("d-none");
  }
  
  /* ==========================================================
     Berechnungsfunktion (Berechnung)
  ========================================================= */
  function doCalculation(e) {
    e.preventDefault();
    const ersteller = document.getElementById("ersteller").value.trim();
    const standort = document.getElementById("standort").value.trim() || "-";
    const kultur = document.getElementById("kultur").value.trim() || "-";
    const kistenanzahl = parseFloat(document.getElementById("kistenanzahl").value);
    
    if (!ersteller || isNaN(kistenanzahl)) {
      alert("Bitte Felder korrekt ausfüllen!");
      return;
    }
    
    // Kopfbereich aktualisieren
    document.getElementById("erstellerName").textContent = ersteller;
    document.getElementById("standortName").textContent = standort;
    document.getElementById("kulturName").textContent = kultur;
    
    const heute = new Date();
    const datumString = heute.toLocaleDateString("de-DE", { year: "numeric", month: "2-digit", day: "2-digit" });
    document.getElementById("datum").textContent = datumString;
    
    const resultsTableBody = document.querySelector("#resultsTable tbody");
    resultsTableBody.innerHTML = "";
    
    // Flächenberechnung:
    const arValue = kistenanzahl / 300;
    const sqmValue = kistenanzahl * 0.33;
    
    const resultItems = [];
    mittelDaten.forEach(m => {
      let ergebnis = 0;
      if (m.calcMethod === "perKiste") {
        ergebnis = m.value * kistenanzahl;
      } else if (m.calcMethod === "percentWater") {
        const gesamtWasser = (kistenanzahl / 300) * 5;
        ergebnis = gesamtWasser * (m.value / 100);
      }
      resultItems.push({
        name: m.name,
        unit: m.unit,
        calcMethod: m.calcMethod,
        value: m.value,
        total: ergebnis,
        kisten: kistenanzahl,
        ar: arValue,
        sqm: sqmValue
      });
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m.name}</td>
        <td>${m.unit}</td>
        <td>${m.calcMethod}</td>
        <td>${m.value}</td>
        <td>${kistenanzahl}</td>
        <td>${arValue.toFixed(2)}</td>
        <td>${sqmValue.toFixed(2)}</td>
        <td>${ergebnis.toFixed(2)} ${m.unit}</td>
      `;
      resultsTableBody.appendChild(tr);
    });
    
    currentCalculation = {
      date: datumString,
      ersteller,
      standort,
      kultur,
      kisten: kistenanzahl,
      items: resultItems
    };
    
    document.getElementById("resultSection").classList.remove("d-none");
  }
  
  /* ==========================================================
     Historie: Anzeige, Detailansicht, Löschen
  ========================================================= */
  function renderHistoryTable() {
    const tbody = document.querySelector("#historyTable tbody");
    tbody.innerHTML = "";
    historyData.forEach((entry, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${entry.date}</td>
        <td>${entry.ersteller}</td>
        <td>${entry.standort}</td>
        <td>${entry.kultur}</td>
        <td>${entry.kisten}</td>
        <td>
          <button class="btn btn-sm btn-info" data-action="view" data-index="${index}">Ansehen</button>
          <button class="btn btn-sm btn-danger" data-action="delete" data-index="${index}">Löschen</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  function showDetail(index) {
    const entry = historyData[index];
    if (!entry) return;
    const detailSection = document.getElementById("detailSection");
    const detailBody = document.getElementById("detailBody");
    detailSection.classList.remove("d-none");
    let html = `
      <p>
        <strong>Datum:</strong> ${entry.date}<br/>
        <strong>Erstellt von:</strong> ${entry.ersteller}<br/>
        <strong>Standort / Abteil:</strong> ${entry.standort}<br/>
        <strong>Kultur:</strong> ${entry.kultur}<br/>
        <strong>Kisten:</strong> ${entry.kisten}
      </p>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Mittel</th>
              <th>Einheit</th>
              <th>Methode</th>
              <th>Wert</th>
              <th>Kisten</th>
              <th>Ar</th>
              <th>m²</th>
              <th>Gesamt</th>
            </tr>
          </thead>
          <tbody>
    `;
    entry.items.forEach(item => {
      html += `
        <tr>
          <td>${item.name}</td>
          <td>${item.unit}</td>
          <td>${item.calcMethod}</td>
          <td>${item.value}</td>
          <td>${item.kisten}</td>
          <td>${item.ar.toFixed(2)}</td>
          <td>${item.sqm.toFixed(2)}</td>
          <td>${item.total.toFixed(2)} ${item.unit}</td>
        </tr>
      `;
    });
    html += `
          </tbody>
        </table>
      </div>
      <button class="btn btn-outline-secondary no-print" onclick="window.print()">Drucken / PDF</button>
    `;
    detailBody.innerHTML = html;
  }
  
  /* ==========================================================
     Auswertung: Filter und Anzeige
  ========================================================= */
  function parseGermanDate(dateStr) {
    // Bei type="date" erhalten wir den Wert bereits als ISO-Format (yyyy-mm-dd)
    return new Date(dateStr);
  }
  
  function filterByDateRange(e) {
    e.preventDefault();
    const startVal = document.getElementById("startDate").value;
    const endVal = document.getElementById("endDate").value;
    const startDate = parseGermanDate(startVal);
    const endDate = parseGermanDate(endVal);
    if (!startDate || !endDate) {
      alert("Bitte gültige Daten auswählen!");
      return;
    }
    const filtered = historyData.filter(entry => {
      // Umwandlung des gespeicherten Datums (Format "TT.MM.JJJJ") in ISO
      const parts = entry.date.split('.');
      const isoDate = new Date(parts[2], parts[1]-1, parts[0]);
      return (isoDate >= startDate && isoDate <= endDate);
    });
    renderAuswertungTable(filtered);
  }
  
  function renderAuswertungTable(dataArr) {
    const tbody = document.querySelector("#auswertungTable tbody");
    tbody.innerHTML = "";
    dataArr.forEach(entry => {
      let mittelHtml = "";
      entry.items.forEach(item => {
        mittelHtml += `<div><strong>${item.name}:</strong> ${parseFloat(item.total).toFixed(2)} ${item.unit}</div>`;
      });
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${entry.date}</td>
        <td>${entry.ersteller}</td>
        <td>${entry.standort}</td>
        <td>${entry.kultur}</td>
        <td>${entry.kisten}</td>
        <td>${mittelHtml}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  /* ==========================================================
     Initialisierung der App (Event-Binding)
  ========================================================= */
  function initializeApp() {
    showSection("calc");
    
    // Berechnungs-Formular
    document.getElementById("calculationForm").addEventListener("submit", doCalculation);
    
    // Speichern der aktuellen Berechnung in der Historie
    document.getElementById("saveHistoryBtn").addEventListener("click", () => {
      if (!currentCalculation) {
        alert("Keine Berechnung zum Speichern vorhanden!");
        return;
      }
      historyData.push(currentCalculation);
      saveDatabase();
      alert("Berechnung gespeichert! (Siehe Historie)");
      renderHistoryTable();
    });
    
    // Historie: Klick-Events (Ansehen, Löschen)
    document.querySelector("#historyTable tbody").addEventListener("click", (e) => {
      const action = e.target.getAttribute("data-action");
      const idx = e.target.getAttribute("data-index");
      if (action === "view") {
        showDetail(idx);
      } else if (action === "delete") {
        if (confirm("Wirklich löschen?")) {
          historyData.splice(idx, 1);
          saveDatabase();
          renderHistoryTable();
          document.getElementById("detailSection").classList.add("d-none");
        }
      }
    });
    
    // Einstellungen: Mittel-Verwaltung
    renderMittelTable();
    document.getElementById("mittelTable").addEventListener("input", (e) => {
      if (e.target.hasAttribute("data-index")) {
        const index = +e.target.getAttribute("data-index");
        const field = e.target.getAttribute("data-field");
        let val = e.target.value;
        if (field === "value") {
          val = parseFloat(val);
        }
        mittelDaten[index][field] = val;
        saveDatabase();
        renderMittelTable();
      }
    });
    document.getElementById("mittelTable").addEventListener("click", (e) => {
      if (e.target.getAttribute("data-action") === "deleteMittel") {
        const idx = +e.target.getAttribute("data-index");
        mittelDaten.splice(idx, 1);
        saveDatabase();
        renderMittelTable();
      }
    });
    document.getElementById("addMittelForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const name = document.getElementById("mittelName").value.trim();
      const unit = document.getElementById("mittelUnit").value.trim();
      const calcMethod = document.getElementById("mittelMethod").value;
      const value = parseFloat(document.getElementById("mittelValue").value);
      mittelDaten.push({ name, unit, calcMethod, value });
      saveDatabase();
      renderMittelTable();
      e.target.reset();
    });
    
    // Auswertung: Datumsfilter
    document.getElementById("filterForm").addEventListener("submit", filterByDateRange);
  }
  
  /* ==========================================================
     Rendern der Mittel-Tabelle in Einstellungen
  ========================================================= */
  function renderMittelTable() {
    const tbody = document.querySelector("#mittelTable tbody");
    tbody.innerHTML = "";
    mittelDaten.forEach((m, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <input type="text" class="form-control" value="${m.name}" data-index="${index}" data-field="name" />
        </td>
        <td>
          <input type="text" class="form-control" value="${m.unit}" data-index="${index}" data-field="unit" />
        </td>
        <td>
          <select class="form-select" data-index="${index}" data-field="calcMethod">
            <option value="perKiste" ${m.calcMethod==="perKiste"?"selected":""}>perKiste</option>
            <option value="percentWater" ${m.calcMethod==="percentWater"?"selected":""}>% vom Wasser</option>
          </select>
        </td>
        <td>
          <input type="number" step="any" class="form-control" value="${m.value}" data-index="${index}" data-field="value" />
        </td>
        <td>
          <button class="btn btn-danger btn-sm" data-index="${index}" data-action="deleteMittel">Löschen</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  /* ==========================================================
     DOMContentLoaded: Startup-Buttons binden
  ========================================================= */
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("createDbBtn").addEventListener("click", createNewDatabase);
    document.getElementById("openDbBtn").addEventListener("click", openDatabase);
  });
</script>
</body>
</html>
